parameters:
- name: environment
  type: string
- name: user_assigned_managed_identity_id
  type: string

steps:
- script: curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
  displayName: Install az cli

- bash: echo 'Deploying to the ${{ parameters.environment }} environment'
- script: |
    az login --identity --username ${{ parameters.user_assigned_managed_identity_id }}

    # Get and check the data lake name
    DATA_LAKE_NAME=$(az keyvault secret show --vault-name $(CONFIGURATION_REGISTRY_NAME) --name data-lake-name-${{ parameters.environment }} --query 'value' -o tsv)
    test "$DATA_LAKE_NAME" || exit 1

    # We have to use the account key while the sync command doesn't support managed identites
    # Get and check the data lake key
    DATA_LAKE_KEY=$(az storage account keys list --account-name $DATA_LAKE_NAME --query '[0].value' -o tsv)
    test "$DATA_LAKE_KEY" || exit 1

    az storage blob sync --account-name $DATA_LAKE_NAME --account-key $DATA_LAKE_KEY -c dbt -s dbt --only-show-errors
  displayName: 'Sync the repository files to the data lake'
